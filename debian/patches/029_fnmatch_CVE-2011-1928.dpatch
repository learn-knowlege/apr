#! /bin/sh /usr/share/dpatch/dpatch-run
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: fix additional apr_fnmatch DoS for CVE-2011-1928
# origin: http://mail-archives.apache.org/mod_mbox/httpd-announce/201105.mbox/%3C4DD55092.3030403@apache.org%3E
# subject: regression in apr 1.4.4 from fix for CVE-2011-0419
@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' apr-1.4.2~/strings/apr_fnmatch.c apr-1.4.2/strings/apr_fnmatch.c
--- apr-1.4.2~/strings/apr_fnmatch.c	2011-05-20 14:14:35.000000000 -0700
+++ apr-1.4.2/strings/apr_fnmatch.c	2011-05-20 14:14:36.000000000 -0700
@@ -196,7 +196,10 @@
     const char *mismatch = NULL;
     int matchlen = 0;
 
-    while (*pattern)
+    if (*pattern == '*')
+        goto firstsegment;
+
+    while (*pattern && *string)
     {
         /* Match balanced slashes, starting a new segment pattern
          */
@@ -207,6 +210,7 @@
             ++string;
         }            
 
+firstsegment:
         /* At the beginning of each segment, validate leading period behavior.
          */
         if ((flags & APR_FNM_PERIOD) && (*string == '.'))
@@ -361,9 +365,9 @@
             return APR_FNM_NOMATCH;
     }
 
-    /* pattern is at EOS; if string is also, declare success
+    /* Where both pattern and string are at EOS, declare success
      */
-    if (!*string)
+    if (!*string && !*pattern)
         return 0;
 
     /* pattern didn't match to the end of string */
